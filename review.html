<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√úberpr√ºfen Sie Ihre Angaben</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
* {margin:0;padding:0;box-sizing:border-box;}
body {
  font-family:'Roboto',sans-serif;
  background:#f4f6f8;color:#333;
  min-height:100vh;line-height:1.6;
}
a {text-decoration:none;color:inherit;}

/* HEADER */
.Kopfzeile {
  position:fixed;top:0;left:0;right:0;
  padding:15px 30px;
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  background:#ffffffcc;
  box-shadow:0 4px 20px rgba(0,0,0,0.08);
  border-bottom-left-radius:12px;
  border-bottom-right-radius:12px;
  backdrop-filter:blur(5px);
  z-index:1000;
}

.left-logo img {height:80px;}
.center-logo {display:flex;justify-content:center;}
.center-logo img {height:100px;}
.right-menu {display:flex;justify-content:flex-end;}

.menu-button {
  display:flex;flex-direction:column;width:32px;height:24px;
  justify-content:space-between;cursor:pointer;
}
.menu-button div {
  width:100%;height:3px;background:#0077cc;
  border-radius:2px;transition:0.3s;
}
.menu-button.open div:nth-child(1){transform:rotate(45deg) translateY(8px);}
.menu-button.open div:nth-child(2){opacity:0;}
.menu-button.open div:nth-child(3){transform:rotate(-45deg) translateY(-8px);}

.nav-links {
  display:none;flex-direction:column;background:#fff;
  position:absolute;right:20px;top:90px;width:200px;
  padding:15px;border-radius:12px;
  box-shadow:0 8px 18px rgba(0,0,0,0.15);
}
.nav-links.active {display:flex;}

.Kopfzeile-Link {
  font-size:16px;padding:10px 12px;
  border-radius:8px;transition:0.3s;
}
.Kopfzeile-Link:hover {background:#e0f0ff;color:#0077cc;}

@media(max-width:768px){
  .left-logo img {height:60px;}
  .center-logo img {height:55px;}
}

/* CONTENT */
.content-wrapper {
  margin:130px 20px 40px;
  max-width:800px;
  margin-left:auto;
  margin-right:auto;
}

h2 {
  text-align:center;color:#0077cc;margin-bottom:20px;
}

.section {
  background:white;padding:25px;border-radius:16px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.06);
}

.field {margin-bottom:10px;}
.field span {font-weight:600;}

.moebel-list {
  margin-top:10px;
  padding:10px;
  background:#f7f9fc;
  border-radius:8px;
}

.moebel-item {
  padding:8px;
  margin-bottom:6px;
  background:white;
  border-radius:6px;
  font-size:14px;
}

button {
  padding:14px 20px;font-size:18px;font-weight:600;
  border:none;border-radius:12px;cursor:pointer;
  margin:10px 5px;
  background:linear-gradient(90deg,#0077cc,#00aaff);
  color:white;transition:0.3s;
}

button:hover {
  background:linear-gradient(90deg,#005fa3,#0099dd);
}

button:active {transform:scale(0.97);}

#back {background:#ccc;color:#000;}

/* LOADING */
.loading {
  text-align:center;
  padding:40px;
  color:#0077cc;
  font-size:18px;
}

/* FOOTER */
.footer {
  background:#0077cc;padding:40px 20px;
  color:#fff;margin-top:40px;
}

.footer-container {
  max-width:1100px;margin:0 auto;
  display:flex;justify-content:space-between;flex-wrap:wrap;
}

.footer-section {width:30%;text-align:center;}

@media(max-width:850px){
  .footer-section {width:100%;margin-bottom:25px;}
}

.footer h3 {font-size:22px;margin-bottom:12px;}

.footer-section a {
  font-size:20px;color:#00e0ff;font-weight:500;
}
.footer-section a:hover {
  color:white;text-decoration:underline;
}

.footer-section p {margin:5px 0;}
</style>
</head>
<body>

<!-- HEADER -->
<div class="Kopfzeile">
  <div class="left-logo">
    <a href="index.html"><img src="Img/Logo2.png" alt="Logo"></a>
  </div>
  <div class="center-logo">
    <a href="index.html"><img src="Img/Logo.png" alt="Logo Mitte"></a>
  </div>
  <div class="right-menu">
    <div class="menu-button" id="menuButton"><div></div><div></div><div></div></div>
  </div>
  <div class="nav-links" id="navLinks">
    <a class="Kopfzeile-Link" href="index.html">Home</a>
    <a class="Kopfzeile-Link" href="Umzug.html">Umzug</a>
    <a class="Kopfzeile-Link" href="MoebelAufbau.html">M√∂bel Ab-/Aufbau</a>
    <a class="Kopfzeile-Link" href="Transport.html">Transport</a>
    <a class="Kopfzeile-Link" href="√úberUns.html">√úber uns</a>
  </div>
</div>

<!-- CONTENT -->
<div class="content-wrapper">
  <h2>Bitte √ºberpr√ºfen Sie alle Angaben</h2>
  <div id="content">
    <div class="loading">üîÑ Berechnung l√§uft...<br>Bitte warten Sie einen Moment.</div>
  </div>
  <div style="text-align:center;">
    <button id="back">Zur√ºck</button>
    <button id="confirm">Angebot anfordern</button>
  </div>
</div>

<!-- FOOTER -->
<footer class="footer">
  <div class="footer-container">
    <div class="footer-section">
      <a href="Impressum.html">Impressum</a>
    </div>
    <div class="footer-section">
      <h3>Kontakt</h3>
      <p><a href="mailto:studies.kontakt@gmail.com">studies.kontakt@gmail.com</a></p>
      <p><a href="tel:+491782550568">+49 178 2550 568</a></p>
    </div>
    <div class="footer-section">
      <a href="Datenschutz.html">Datenschutz</a>
    </div>
  </div>
</footer>

<script>
const menuButton = document.getElementById('menuButton');
const navLinks = document.getElementById('navLinks');
menuButton.addEventListener('click', () => {
  navLinks.classList.toggle('active');
  menuButton.classList.toggle('open');
});

function getQueryData() {
  const params = new URLSearchParams(window.location.search);
  const data = {};
  params.forEach((v,k) => {
    if(k === 'moebel') {
      try {
        data[k] = JSON.parse(v);
      } catch(e) {
        data[k] = [];
      }
    } else {
      data[k] = v;
    }
  });
  return data;
}

// Fahrten berechnen
function calculateTrips(groesse) {
  return Math.ceil(groesse / 20);
}

// ‚úÖ VERBESSERTE Entfernung berechnen mit Fehlerbehandlung
async function getDistance(vonAdresse, nachAdresse) {
  const apiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjZhMzUxMGQyMDMzODRhNzNiY2ExYmFiYjRjYTRhYTRkIiwiaCI6Im11cm11cjY0In0=';
  try {
    let res = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(vonAdresse)}`);
    if (!res.ok) throw new Error('Geocoding failed');
    let data = await res.json();
    if (!data.features || data.features.length === 0) throw new Error('Address not found');
    const vonCoords = data.features[0].geometry.coordinates;

    res = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(nachAdresse)}`);
    if (!res.ok) throw new Error('Geocoding failed');
    data = await res.json();
    if (!data.features || data.features.length === 0) throw new Error('Address not found');
    const nachCoords = data.features[0].geometry.coordinates;

    res = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
      method:'POST',
      headers:{'Authorization':apiKey,'Content-Type':'application/json'},
      body:JSON.stringify({coordinates:[vonCoords,nachCoords]})
    });
    if (!res.ok) throw new Error('Routing failed');
    data = await res.json();
    const distanceMeters = data.features[0].properties.summary.distance;
    return distanceMeters / 1000;
  } catch(e) {
    console.error('Fehler bei Entfernungsberechnung:', e);
    return 0;
  }
}

// ‚úÖ KORRIGIERTE PREISBERECHNUNG
async function calculatePrice(data) {
  console.log('üîÑ Starte Preisberechnung...');
  
  let price = 80; // Basispreis
  
  // AUSZUG
  price += (Number(data.zimmer_auszug) || 0) * 50;
  price += (Number(data.groesse_auszug) || 0) * 2;
  if (data.aufzug_auszug === 'Nein') price += 20;
  price += (parseInt(data.etage_auszug) || 0) * 5;

  // EINZUG
  price += (Number(data.zimmer_einzug) || 0) * 50;
  price += (Number(data.groesse_einzug) || 0) * 2;
  if (data.aufzug_einzug === 'Nein') price += 20;
  price += (parseInt(data.etage_einzug) || 0) * 5;

  const trips = calculateTrips(Number(data.groesse_auszug));

  // ADRESSEN
  const home = 'Herzogenbuscherstra√üe 1d, 54292 Trier';
  const auszug = `${data.von_strasse} ${data.von_hausnr}, ${data.von_plz} ${data.von_stadt}`;
  const einzug = `${data.nach_strasse} ${data.nach_hausnr}, ${data.nach_plz} ${data.nach_stadt}`;

  console.log('üìç Berechne Entfernungen...');
  
  // ‚úÖ KORRIGIERT: VOLLST√ÑNDIGER RUNDWEG
  const distanceHomeToAuszug = await getDistance(home, auszug);
  console.log(`Home ‚Üí Auszug: ${distanceHomeToAuszug.toFixed(2)} km`);
  
  const distanceAuszugToEinzug = await getDistance(auszug, einzug);
  console.log(`Auszug ‚Üí Einzug: ${distanceAuszugToEinzug.toFixed(2)} km`);
  
  const distanceEinzugToHome = await getDistance(einzug, home);
  console.log(`Einzug ‚Üí Home: ${distanceEinzugToHome.toFixed(2)} km`);

  const kmPreis = 0.83;
  
  // ‚úÖ KORRIGIERTE BERECHNUNG:
  // 1. Home ‚Üí Auszug (einmalig hin)
  const kostenHomeToAuszug = distanceHomeToAuszug * kmPreis;
  
  // 2. Auszug ‚Üî Einzug (mehrere Fahrten)
  const kostenAuszugEinzug = distanceAuszugToEinzug * trips * kmPreis;
  
  // 3. Einzug ‚Üí Home (einmalig zur√ºck)
  const kostenEinzugToHome = distanceEinzugToHome * kmPreis;
  
  const gesamtKM = distanceHomeToAuszug + (distanceAuszugToEinzug * trips) + distanceEinzugToHome;
  const gesamtKMKosten = kostenHomeToAuszug + kostenAuszugEinzug + kostenEinzugToHome;
  
  console.log(`üí∞ KM-Kosten: ${gesamtKMKosten.toFixed(2)}‚Ç¨ (${gesamtKM.toFixed(2)} km)`);
  
  price += gesamtKMKosten;

  // ‚úÖ VERBESSERTE M√ñBELAUFBAU-BERECHNUNG
  if (data.moebel && data.moebel.length > 0) {
    const totalMoebel = data.moebel.reduce((sum, m) => sum + parseInt(m.menge), 0);
    console.log(`ü™ë ${totalMoebel} M√∂belst√ºck(e) gefunden`);
    
    // Progressive Berechnung: 20‚Ç¨ pro M√∂bel + Stundenlohn
    const moebelGrundpreis = totalMoebel * 20;
    
    // Stunden-Sch√§tzung: 30 Min pro M√∂bel
    const geschaetzteStunden = Math.ceil((totalMoebel * 0.5) * 2) / 2; // Gerundet auf halbe Stunden
    const stundenLohn = geschaetzteStunden * 25;
    
    price += moebelGrundpreis + stundenLohn;
    console.log(`ü™ë M√∂belkosten: ${moebelGrundpreis}‚Ç¨ + ${stundenLohn}‚Ç¨ (${geschaetzteStunden}h)`);
    
    data.moebelStunden = geschaetzteStunden;
  }

  data.distanceKm = distanceAuszugToEinzug.toFixed(2);
  data.gesamtKM = gesamtKM.toFixed(2);
  data.trips = trips;
  data.totalPrice = price.toFixed(2);
  
  console.log('‚úÖ Berechnung abgeschlossen. Gesamtpreis:', data.totalPrice, '‚Ç¨');
  return data;
}

function displayData(data) {
  const content = document.getElementById('content');
  const von = `${data.von_strasse} ${data.von_hausnr}, ${data.von_plz} ${data.von_stadt}`;
  const nach = `${data.nach_strasse} ${data.nach_hausnr}, ${data.nach_plz} ${data.nach_stadt}`;
  
  // M√∂bel HTML
  let moebelHTML = '';
  if (data.moebel && data.moebel.length > 0) {
    moebelHTML = '<div class="moebel-list">';
    data.moebel.forEach(m => {
      moebelHTML += `<div class="moebel-item">‚Ä¢ ${m.art} (${m.typ}) - Anzahl: ${m.menge}</div>`;
    });
    moebelHTML += '</div>';
    if (data.moebelStunden) {
      moebelHTML += `<p style="margin-top:10px;color:#666;font-size:14px;">‚è±Ô∏è Gesch√§tzte Arbeitszeit: ${data.moebelStunden} Stunden</p>`;
    }
  } else {
    moebelHTML = '<p style="color:#999;">Keine M√∂bel angegeben</p>';
  }

  content.innerHTML = `
  <div class="section">
    <h3>Von / Nach</h3>
    <div class="field"><span>Von:</span> ${von}</div>
    <div class="field"><span>Nach:</span> ${nach}</div>
    <div class="field"><span>Datum:</span> ${data.datum||'-'}</div>
    <div class="field"><span>Entfernung Auszug‚ÜîEinzug:</span> ${data.distanceKm} km</div>
    <div class="field"><span>üöö Anzahl Fahrten:</span> ${data.trips}x</div>
    <div class="field"><span>üìè Gesamt-KM:</span> ${data.gesamtKM} km</div>
  </div>
  <div class="section">
    <h3>Auszug</h3>
    <div class="field"><span>Wohnart:</span> ${data.wohnart_auszug||'-'}</div>
    <div class="field"><span>Etage:</span> ${data.etage_auszug||'-'}</div>
    <div class="field"><span>Zimmer:</span> ${data.zimmer_auszug||'-'}</div>
    <div class="field"><span>Gr√∂√üe:</span> ${data.groesse_auszug||'-'} m¬≤</div>
    <div class="field"><span>Aufzug:</span> ${data.aufzug_auszug||'-'}</div>
  </div>
  <div class="section">
    <h3>Einzug</h3>
    <div class="field"><span>Wohnart:</span> ${data.wohnart_einzug||'-'}</div>
    <div class="field"><span>Etage:</span> ${data.etage_einzug||'-'}</div>
    <div class="field"><span>Zimmer:</span> ${data.zimmer_einzug||'-'}</div>
    <div class="field"><span>Gr√∂√üe:</span> ${data.groesse_einzug||'-'} m¬≤</div>
    <div class="field"><span>Aufzug:</span> ${data.aufzug_einzug||'-'}</div>
  </div>
  <div class="section">
    <h3>M√∂bel zum Auf-/Abbau</h3>
    ${moebelHTML}
  </div>
  <div class="section">
    <h3>Zusatzoptionen</h3>
    <div class="field"><span>Zahlung durch:</span> ${data.zahlung||'-'}</div>
    <div class="field"><span>Transporter n√∂tig:</span> ${data.transporter||'-'}</div>
  </div>
  <div class="section" style="text-align:center;font-size:22px;font-weight:700;color:#0077cc;">
    üí∞ Gesamtpreis: ${data.totalPrice} ‚Ç¨
  </div>
  `;
}

(async () => {
  let data = getQueryData();
  data = await calculatePrice(data);
  displayData(data);

  document.getElementById('back').addEventListener('click', () => window.history.back());
  document.getElementById('confirm').addEventListener('click', () => {
    sessionStorage.setItem('umzugData', JSON.stringify(data));
    window.location.href = 'kontakt.html';
  });
})();
</script>

</body>
</html>