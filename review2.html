<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√úberpr√ºfen Sie Ihre Angaben</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
* {margin:0;padding:0;box-sizing:border-box;}
body {
  font-family:'Roboto',sans-serif;
  background:#f4f6f8;color:#333;
  min-height:100vh;line-height:1.6;
}
a {text-decoration:none;color:inherit;}

/* HEADER */
.Kopfzeile {
  position:fixed;top:0;left:0;right:0;
  padding:15px 30px;
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  background:#ffffffcc;
  box-shadow:0 4px 20px rgba(0,0,0,0.08);
  border-bottom-left-radius:12px;
  border-bottom-right-radius:12px;
  backdrop-filter:blur(5px);
  z-index:1000;
}

.left-logo img {height:80px;}
.center-logo {display:flex;justify-content:center;}
.center-logo img {height:100px;}
.right-menu {display:flex;justify-content:flex-end;}

.menu-button {
  display:flex;flex-direction:column;width:32px;height:24px;
  justify-content:space-between;cursor:pointer;
}
.menu-button div {
  width:100%;height:3px;background:#0077cc;
  border-radius:2px;transition:0.3s;
}
.menu-button.open div:nth-child(1){transform:rotate(45deg) translateY(8px);}
.menu-button.open div:nth-child(2){opacity:0;}
.menu-button.open div:nth-child(3){transform:rotate(-45deg) translateY(-8px);}

.nav-links {
  display:none;flex-direction:column;background:#fff;
  position:absolute;right:20px;top:90px;width:200px;
  padding:15px;border-radius:12px;
  box-shadow:0 8px 18px rgba(0,0,0,0.15);
}
.nav-links.active {display:flex;}

.Kopfzeile-Link {
  font-size:16px;padding:10px 12px;
  border-radius:8px;transition:0.3s;
}
.Kopfzeile-Link:hover {background:#e0f0ff;color:#0077cc;}

@media(max-width:768px){
  .left-logo img {height:60px;}
  .center-logo img {height:55px;}
}

/* CONTENT */
.content-wrapper {
  margin:130px 20px 40px;
  max-width:800px;
  margin-left:auto;
  margin-right:auto;
}

h2 {
  text-align:center;color:#0077cc;margin-bottom:20px;
}

.section {
  background:white;padding:25px;border-radius:16px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.06);
}

.field {margin-bottom:10px;}
.field span {font-weight:600;}

.moebel-list {
  margin-top:10px;
  padding:15px;
  background:#f7f9fc;
  border-radius:8px;
}

.moebel-item {
  padding:10px;
  margin-bottom:8px;
  background:white;
  border-radius:6px;
  font-size:14px;
  border-left:3px solid #0077cc;
}

.moebel-item:last-child {
  margin-bottom:0;
}

button {
  padding:14px 20px;font-size:18px;font-weight:600;
  border:none;border-radius:12px;cursor:pointer;
  margin:10px 5px;
  background:linear-gradient(90deg,#0077cc,#00aaff);
  color:white;transition:0.3s;
}

button:hover {
  background:linear-gradient(90deg,#005fa3,#0099dd);
}

button:active {transform:scale(0.97);}

#back {background:#ccc;color:#000;}

/* FOOTER */
.footer {
  background:#0077cc;padding:40px 20px;
  color:#fff;margin-top:40px;
}

.footer-container {
  max-width:1100px;margin:0 auto;
  display:flex;justify-content:space-between;flex-wrap:wrap;
}

.footer-section {width:30%;text-align:center;}

@media(max-width:850px){
  .footer-section {width:100%;margin-bottom:25px;}
}

.footer h3 {font-size:22px;margin-bottom:12px;}

.footer-section a {
  font-size:20px;color:#00e0ff;font-weight:500;
}
.footer-section a:hover {
  color:white;text-decoration:underline;
}

.footer-section p {margin:5px 0;}
</style>
</head>
<body>

<!-- HEADER -->
<div class="Kopfzeile">
  <div class="left-logo">
    <a href="index.html"><img src="Img/Logo2.png" alt="Logo"></a>
  </div>
  <div class="center-logo">
    <a href="index.html"><img src="Img/Logo.png" alt="Logo Mitte"></a>
  </div>
  <div class="right-menu">
    <div class="menu-button" id="menuButton"><div></div><div></div><div></div></div>
  </div>
  <div class="nav-links" id="navLinks">
    <a class="Kopfzeile-Link" href="index.html">Home</a>
    <a class="Kopfzeile-Link" href="Umzug.html">Umzug</a>
    <a class="Kopfzeile-Link" href="MoebelAufbau.html">M√∂bel Ab-/Aufbau</a>
    <a class="Kopfzeile-Link" href="Transport.html">Transport</a>
    <a class="Kopfzeile-Link" href="√úberUns.html">√úber uns</a>
  </div>
</div>

<!-- CONTENT -->
<div class="content-wrapper">
  <h2>Bitte √ºberpr√ºfen Sie Ihre Angaben</h2>
  <div id="review"></div>

  <div style="text-align:center;">
    <button id="back">Zur√ºck</button>
    <button id="confirm">Weiter zur Kontaktseite</button>
  </div>
</div>

<!-- FOOTER -->
<footer class="footer">
  <div class="footer-container">
    <div class="footer-section">
      <a href="Impressum.html">Impressum</a>
    </div>
    <div class="footer-section">
      <h3>Kontakt</h3>
      <p><a href="mailto:studies.kontakt@gmail.com">studies.kontakt@gmail.com</a></p>
      <p><a href="tel:+491782550568">+49 178 2550 568</a></p>
    </div>
    <div class="footer-section">
      <a href="Datenschutz.html">Datenschutz</a>
    </div>
  </div>
</footer>

<script>
// Navigation
const menuButton = document.getElementById("menuButton");
const navLinks = document.getElementById("navLinks");
menuButton.onclick = () => {
  navLinks.classList.toggle("active");
  menuButton.classList.toggle("open");
};

// Daten aus URL lesen
function getData() {
  const params = new URLSearchParams(window.location.search);
  const data = {};
  params.forEach((val, key) => {
    if (key === 'moebel') {
      try {
        data[key] = JSON.parse(val);
      } catch {
        data[key] = [];
      }
    } else {
      data[key] = val;
    }
  });
  return data;
}

// Entfernung berechnen (OpenRouteService)
async function getDistance(vonAdresse, nachAdresse) {
  const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjZhMzUxMGQyMDMzODRhNzNiY2ExYmFiYjRjYTRhYTRkIiwiaCI6Im11cm11cjY0In0=";

  try {
    let res = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(vonAdresse)}`);
    let geoData = await res.json();
    const von = geoData.features[0].geometry.coordinates;

    res = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(nachAdresse)}`);
    geoData = await res.json();
    const nach = geoData.features[0].geometry.coordinates;

    res = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
      method: "POST",
      headers: { "Authorization": apiKey, "Content-Type": "application/json" },
      body: JSON.stringify({ coordinates: [von, nach] })
    });

    geoData = await res.json();
    return geoData.features[0].properties.summary.distance / 1000;
  } catch (e) {
    console.error('Fehler bei Entfernungsberechnung:', e);
    return 0;
  }
}

// Preisberechnung
async function calculatePrice(data) {
  let price = 0;

  // 1. M√ñBEL-KOSTEN
  let anzahlMoebel = 0;
  if (data.moebel && data.moebel.length > 0) {
    data.moebel.forEach(item => {
      const menge = Number(item.menge);
      anzahlMoebel += menge;
      
      // Bei "Beides" (Auf- UND Abbau): Doppelter Preis pro M√∂bel
      if (data.aufbauAbb === "Beides") {
        price += 20 * 2 * menge; // 40‚Ç¨ pro M√∂bel (Auf- + Abbau)
      } else {
        price += 20 * menge; // 20‚Ç¨ pro M√∂bel
      }
    });
  }

  // 2. ARBEITSSTUNDEN
  // Pro M√∂bel ca. 35 Minuten = 0,583 Stunden
  const minutenProMoebel = 35;
  const stundenlohn = 25;
  
  let gesamtStunden = 0;
  if (data.aufbauAbb === "Beides") {
    // Abbau + Aufbau
    const stundenAbbau = (anzahlMoebel * minutenProMoebel) / 60;
    const stundenAufbau = (anzahlMoebel * minutenProMoebel) / 60;
    gesamtStunden = stundenAbbau + stundenAufbau;
  } else {
    // Nur Aufbau ODER Abbau
    gesamtStunden = (anzahlMoebel * minutenProMoebel) / 60;
  }
  
  // Runden nach Regeln: ab 31 Min = volle Stunde, darunter = halbe Stunde
  const volleStunden = Math.floor(gesamtStunden);
  const restMinuten = (gesamtStunden - volleStunden) * 60;
  
  let abgerechneteStunden;
  if (restMinuten >= 31) {
    abgerechneteStunden = volleStunden + 1;
  } else if (restMinuten > 0) {
    abgerechneteStunden = volleStunden + 0.5;
  } else {
    abgerechneteStunden = volleStunden;
  }
  
  price += abgerechneteStunden * stundenlohn;

  // 3. ENTFERNUNGSKOSTEN
  const home = "Herzogenbuscherstra√üe 1d, 54292 Trier";
  let entfernungGesamt = 0;

  if (data.aufbauAbb === "Beides") {
    if (data.adresse1) entfernungGesamt += await getDistance(home, data.adresse1);
    if (data.adresse2) entfernungGesamt += await getDistance(home, data.adresse2);
  } else {
    if (data.adresse1) entfernungGesamt += await getDistance(home, data.adresse1);
  }

  price += entfernungGesamt * 2 * 0.83; // Hin- und R√ºckfahrt

  // Daten speichern
  data.anzahlMoebel = anzahlMoebel;
  data.abgerechneteStunden = abgerechneteStunden;
  data.entfernungGesamt = entfernungGesamt.toFixed(2);
  data.totalPrice = price.toFixed(2);

  return data;
}

// Daten anzeigen + speichern
async function render() {
  const data = await calculatePrice(getData());

  // M√∂bel HTML
  let moebelHTML = '';
  if (data.moebel && data.moebel.length > 0) {
    moebelHTML = '<div class="moebel-list">';
    data.moebel.forEach(m => {
      moebelHTML += `<div class="moebel-item">üì¶ ${m.art} (${m.typ}) - Anzahl: ${m.menge}</div>`;
    });
    moebelHTML += '</div>';
  } else {
    moebelHTML = '<p style="color:#999;font-style:italic;">Keine M√∂bel angegeben</p>';
  }

  // Anzeige
  document.getElementById("review").innerHTML = `
    <div class="section">
      <h3>Adresse(n)</h3>
      ${data.aufbauAbb === "Beides" ? `
        <div class="field"><span>Aufbau-Adresse:</span> ${data.adresse1 || '-'}</div>
        <div class="field"><span>Abbau-Adresse:</span> ${data.adresse2 || '-'}</div>
      ` : `
        <div class="field"><span>Adresse:</span> ${data.adresse1 || '-'}</div>
      `}
    </div>

    <div class="section">
      <h3>Auf-/Abbau</h3>
      <div class="field"><span>Art:</span> ${data.aufbauAbb || '-'}</div>
      ${data.aufbau_text ? `<div class="field"><span>Zusatzinfo:</span> ${data.aufbau_text}</div>` : ""}
    </div>

    <div class="section">
      <h3>M√∂bel</h3>
      ${moebelHTML}
      <div class="field" style="margin-top:15px;"><span>Gesamt-Anzahl:</span> ${data.anzahlMoebel} M√∂belst√ºck${data.anzahlMoebel !== 1 ? 'e' : ''}</div>
      <div class="field"><span>Arbeitsstunden:</span> ${data.abgerechneteStunden} Std.</div>
    </div>

    <div class="section" style="text-align:center;font-size:20px;font-weight:600;">
      üìç Entfernung gesamt: ${data.entfernungGesamt} km<br><br>
      üí∞ Gesamtpreis: ${data.totalPrice} ‚Ç¨
    </div>
  `;

  // ‚úì ALLE Daten speichern f√ºr kontakt2.html
  sessionStorage.setItem("fullReviewData", JSON.stringify(data));
}

document.getElementById("back").onclick = () => history.back();
document.getElementById("confirm").onclick = () => location.href = "kontakt2.html";

render();
</script>

</body>
</html>